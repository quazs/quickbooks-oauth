/*
================================================================================
COMPLETE DAX MEASURES LIBRARY - HOME CARE EDITION (BULLETPROOF)
Financial Intelligence Dashboard for CPAs
================================================================================
Version: 2.0 - NO CIRCULAR REFERENCES
Total Measures: 133
Industry Focus: Home Care / Home Health Companies

IMPROVEMENTS IN V2.0:
‚úÖ All measures recalculated from source tables where possible
‚úÖ No circular reference risks
‚úÖ Clearer dependency hierarchy
‚úÖ Better performance
‚úÖ Explicit calculations for transparency

NAMING CONVENTION:
Measures use prefixes for organization:
- REV - Revenue metrics (calculated from Invoice, SalesReceipt)
- EXP - Expense metrics (calculated from Purchase, Bill)
- TAX - Tax planning (calculated from PurchaseLineItems)
- AR - Accounts receivable (calculated from Invoice)
- AP - Accounts payable (calculated from Bill)
- CUST - Customer metrics (calculated from Customer, Invoice)
- CASH - Cash flow (calculated from Payment, BillPayment)
- KPI - Key performance indicators (calculated from base metrics)
- HC - Home Care specific (calculated from line items)

FORMATTING GUIDE:
üí∞ Currency: $ English (United States), 0 decimals
üìä Percentage: Percentage, 1 decimal  
üî¢ Whole Number: Whole number, 0 decimals

================================================================================
*/


// ================================================================================
// SECTION 1: BASE REVENUE METRICS (12 measures)
// These are the foundation - calculate directly from tables
// ================================================================================

// üí∞ Total revenue from invoices
REV - Total Revenue = SUM(Invoice[TotalAmount])
// Format: Currency, 0 decimals

// üí∞ Revenue from cash sales
REV - Cash Sales = SUM(SalesReceipt[Amount])
// Format: Currency, 0 decimals

// üí∞ Total sales (direct calculation)
REV - Total Sales = SUM(Invoice[TotalAmount]) + SUM(SalesReceipt[Amount])
// Format: Currency, 0 decimals

// üí∞ Revenue from same period last year
REV - Last Year = CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date]))
// Format: Currency, 0 decimals

// üìä Year-over-year revenue growth
REV - Growth % YoY = 
VAR CurrentRev = SUM(Invoice[TotalAmount])
VAR LastYearRev = CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date]))
RETURN DIVIDE(CurrentRev - LastYearRev, LastYearRev, 0)
// Format: Percentage, 1 decimal

// üí∞ Month-to-date revenue
REV - MTD = TOTALMTD(SUM(Invoice[TotalAmount]), Calendar[Date])
// Format: Currency, 0 decimals

// üí∞ Quarter-to-date revenue
REV - QTD = TOTALQTD(SUM(Invoice[TotalAmount]), Calendar[Date])
// Format: Currency, 0 decimals

// üí∞ Year-to-date revenue
REV - YTD = TOTALYTD(SUM(Invoice[TotalAmount]), Calendar[Date])
// Format: Currency, 0 decimals

// üí∞ Revenue from last month
REV - Last Month = CALCULATE(SUM(Invoice[TotalAmount]), DATEADD(Calendar[Date], -1, MONTH))
// Format: Currency, 0 decimals

// üìä Month-over-month revenue growth
REV - Growth % MoM = 
VAR CurrentRev = SUM(Invoice[TotalAmount])
VAR LastMonthRev = CALCULATE(SUM(Invoice[TotalAmount]), DATEADD(Calendar[Date], -1, MONTH))
RETURN DIVIDE(CurrentRev - LastMonthRev, LastMonthRev, 0)
// Format: Percentage, 1 decimal

// üí∞ Average revenue per invoice
REV - Avg Per Invoice = DIVIDE(SUM(Invoice[TotalAmount]), COUNTROWS(Invoice), 0)
// Format: Currency, 0 decimals

// üí∞ 3-month moving average revenue
REV - 3Mo Moving Avg = 
CALCULATE(
    AVERAGEX(
        DATESINPERIOD(Calendar[Date], LASTDATE(Calendar[Date]), -3, MONTH),
        SUM(Invoice[TotalAmount])
    )
)
// Format: Currency, 0 decimals


// ================================================================================
// SECTION 2: BASE EXPENSE METRICS (12 measures)
// Calculate directly from Purchase and Bill tables
// ================================================================================

// üí∞ Total expenses from purchases
EXP - Total Expenses = SUM(Purchase[Amount])
// Format: Currency, 0 decimals

// üí∞ Expenses from same period last year
EXP - Last Year = CALCULATE(SUM(Purchase[Amount]), SAMEPERIODLASTYEAR(Calendar[Date]))
// Format: Currency, 0 decimals

// üìä Year-over-year expense growth
EXP - Growth % YoY = 
VAR CurrentExp = SUM(Purchase[Amount])
VAR LastYearExp = CALCULATE(SUM(Purchase[Amount]), SAMEPERIODLASTYEAR(Calendar[Date]))
RETURN DIVIDE(CurrentExp - LastYearExp, LastYearExp, 0)
// Format: Percentage, 1 decimal

// üí∞ Year-to-date expenses
EXP - YTD = TOTALYTD(SUM(Purchase[Amount]), Calendar[Date])
// Format: Currency, 0 decimals

// üí∞ Quarter-to-date expenses
EXP - QTD = TOTALQTD(SUM(Purchase[Amount]), Calendar[Date])
// Format: Currency, 0 decimals

// üí∞ Expenses from last month
EXP - Last Month = CALCULATE(SUM(Purchase[Amount]), DATEADD(Calendar[Date], -1, MONTH))
// Format: Currency, 0 decimals

// üìä Month-over-month expense growth
EXP - Growth % MoM = 
VAR CurrentExp = SUM(Purchase[Amount])
VAR LastMonthExp = CALCULATE(SUM(Purchase[Amount]), DATEADD(Calendar[Date], -1, MONTH))
RETURN DIVIDE(CurrentExp - LastMonthExp, LastMonthExp, 0)
// Format: Percentage, 1 decimal

// üìä Expense ratio (calculated from base)
EXP - Expense Ratio = DIVIDE(SUM(Purchase[Amount]), SUM(Invoice[TotalAmount]), 0)
// Format: Percentage, 1 decimal

// üí∞ Average expense per transaction
EXP - Avg Per Transaction = DIVIDE(SUM(Purchase[Amount]), COUNTROWS(Purchase), 0)
// Format: Currency, 0 decimals

// üí∞ Cost of goods sold
EXP - COGS = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, Account[AccountType] = "Cost of Goods Sold")
)
// Format: Currency, 0 decimals

// üí∞ Operating expenses (excluding COGS)
EXP - Operating = 
VAR TotalExp = SUM(Purchase[Amount])
VAR COGS = CALCULATE(SUM(PurchaseLineItems[Amount]), FILTER(Account, Account[AccountType] = "Cost of Goods Sold"))
RETURN TotalExp - COGS
// Format: Currency, 0 decimals

// üí∞ Monthly burn rate (simple average)
EXP - Monthly Burn Rate = DIVIDE(SUM(Purchase[Amount]), 12, 0)
// Format: Currency, 0 decimals


// ================================================================================
// SECTION 3: PROFITABILITY METRICS (10 measures)
// Calculate from base revenue and expense measures
// ================================================================================

// üí∞ Gross profit (direct calculation)
PROFIT - Gross Profit = SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])
// Format: Currency, 0 decimals

// üìä Gross profit margin
PROFIT - Gross Margin % = DIVIDE(SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount]), SUM(Invoice[TotalAmount]), 0)
// Format: Percentage, 1 decimal

// üí∞ Net income (comprehensive - direct calculation)
PROFIT - Net Income = SUM(Invoice[TotalAmount]) + SUM(SalesReceipt[Amount]) - SUM(Purchase[Amount])
// Format: Currency, 0 decimals

// üìä Net profit margin
PROFIT - Net Margin % = 
VAR TotalSales = SUM(Invoice[TotalAmount]) + SUM(SalesReceipt[Amount])
VAR NetIncome = TotalSales - SUM(Purchase[Amount])
RETURN DIVIDE(NetIncome, TotalSales, 0)
// Format: Percentage, 1 decimal

// üí∞ EBITDA (simplified - same as gross profit for most SMBs)
PROFIT - EBITDA = SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])
// Format: Currency, 0 decimals

// üìä Operating margin
PROFIT - Operating Margin % = 
VAR TotalSales = SUM(Invoice[TotalAmount]) + SUM(SalesReceipt[Amount])
VAR GrossProfit = SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])
RETURN DIVIDE(GrossProfit, TotalSales, 0)
// Format: Percentage, 1 decimal

// üí∞ Gross profit year-to-date
PROFIT - Gross Profit YTD = 
TOTALYTD(SUM(Invoice[TotalAmount]), Calendar[Date]) - TOTALYTD(SUM(Purchase[Amount]), Calendar[Date])
// Format: Currency, 0 decimals

// üí∞ Break-even revenue (direct calculation)
PROFIT - Break Even Revenue = SUM(Purchase[Amount])
// Format: Currency, 0 decimals

// üìä Contribution margin
PROFIT - Contribution Margin % = 1 - DIVIDE(SUM(Purchase[Amount]), SUM(Invoice[TotalAmount]), 0)
// Format: Percentage, 1 decimal

// üí∞ Profit per customer
PROFIT - Per Customer = 
VAR GrossProfit = SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])
VAR Customers = DISTINCTCOUNT(Invoice[CustomerId])
RETURN DIVIDE(GrossProfit, Customers, 0)
// Format: Currency, 0 decimals


// ================================================================================
// SECTION 4: ACCOUNTS RECEIVABLE (10 measures)
// Calculate directly from Invoice table
// ================================================================================

// üí∞ Total AR outstanding
AR - Total Outstanding = SUM(Invoice[Balance])
// Format: Currency, 0 decimals

// üí∞ AR aged 0-30 days
AR - 0-30 Days = 
CALCULATE(
    SUM(Invoice[Balance]),
    FILTER(Invoice, Invoice[Date] >= TODAY() - 30 && Invoice[Balance] > 0)
)
// Format: Currency, 0 decimals

// üí∞ AR aged 31-60 days
AR - 31-60 Days = 
CALCULATE(
    SUM(Invoice[Balance]),
    FILTER(Invoice, Invoice[Date] >= TODAY() - 60 && Invoice[Date] < TODAY() - 30 && Invoice[Balance] > 0)
)
// Format: Currency, 0 decimals

// üí∞ AR aged 61-90 days
AR - 61-90 Days = 
CALCULATE(
    SUM(Invoice[Balance]),
    FILTER(Invoice, Invoice[Date] >= TODAY() - 90 && Invoice[Date] < TODAY() - 60 && Invoice[Balance] > 0)
)
// Format: Currency, 0 decimals

// üí∞ AR aged over 90 days
AR - Over 90 Days = 
CALCULATE(
    SUM(Invoice[Balance]),
    FILTER(Invoice, Invoice[Date] < TODAY() - 90 && Invoice[Balance] > 0)
)
// Format: Currency, 0 decimals

// üìä Percentage of AR over 90 days
AR - Over 90 % = 
VAR Total = SUM(Invoice[Balance])
VAR Over90 = CALCULATE(SUM(Invoice[Balance]), FILTER(Invoice, Invoice[Date] < TODAY() - 90 && Invoice[Balance] > 0))
RETURN DIVIDE(Over90, Total, 0)
// Format: Percentage, 1 decimal

// üî¢ Days sales outstanding
AR - Days Sales Outstanding = DIVIDE(SUM(Invoice[Balance]), SUM(Invoice[TotalAmount]), 0) * 365
// Format: Whole Number

// üìä Collection rate
AR - Collection Rate % = DIVIDE(SUM(Payment[Amount]), SUM(Invoice[TotalAmount]), 0)
// Format: Percentage, 1 decimal

// üî¢ Average days to collect
AR - Avg Days to Collect = 
AVERAGEX(
    FILTER(Invoice, Invoice[Balance] = 0),
    DATEDIFF(Invoice[Date], Invoice[DueDate], DAY)
)
// Format: Whole Number

// üìù AR health status
AR - Health Status = 
VAR Total = SUM(Invoice[Balance])
VAR Over90 = CALCULATE(SUM(Invoice[Balance]), FILTER(Invoice, Invoice[Date] < TODAY() - 90 && Invoice[Balance] > 0))
VAR OverduePercent = DIVIDE(Over90, Total, 0)
RETURN SWITCH(TRUE(), OverduePercent < 0.10, "Healthy", OverduePercent < 0.20, "Monitor", OverduePercent < 0.30, "Warning", "Critical")
// Format: Text


// ================================================================================
// SECTION 5: ACCOUNTS PAYABLE (8 measures)
// Calculate directly from Bill table
// ================================================================================

// üí∞ Total bills outstanding
AP - Total Outstanding = SUM(Bill[Balance])
// Format: Currency, 0 decimals

// üí∞ AP aged 0-30 days
AP - 0-30 Days = 
CALCULATE(
    SUM(Bill[Balance]),
    FILTER(Bill, Bill[Date] >= TODAY() - 30 && Bill[Balance] > 0)
)
// Format: Currency, 0 decimals

// üí∞ AP aged 31-60 days
AP - 31-60 Days = 
CALCULATE(
    SUM(Bill[Balance]),
    FILTER(Bill, Bill[Date] >= TODAY() - 60 && Bill[Date] < TODAY() - 30 && Bill[Balance] > 0)
)
// Format: Currency, 0 decimals

// üí∞ AP aged 61-90 days
AP - 61-90 Days = 
CALCULATE(
    SUM(Bill[Balance]),
    FILTER(Bill, Bill[Date] >= TODAY() - 90 && Bill[Date] < TODAY() - 60 && Bill[Balance] > 0)
)
// Format: Currency, 0 decimals

// üí∞ AP aged over 90 days
AP - Over 90 Days = 
CALCULATE(
    SUM(Bill[Balance]),
    FILTER(Bill, Bill[Date] < TODAY() - 90 && Bill[Balance] > 0)
)
// Format: Currency, 0 decimals

// üî¢ Days payable outstanding
AP - Days Payable Outstanding = DIVIDE(SUM(Bill[Balance]), SUM(Purchase[Amount]), 0) * 365
// Format: Whole Number

// üí∞ Working capital (AR minus AP - direct)
AP - Working Capital = SUM(Invoice[Balance]) - SUM(Bill[Balance])
// Format: Currency, 0 decimals

// üìä AP turnover ratio
AP - Turnover Ratio = DIVIDE(SUM(Purchase[Amount]), SUM(Bill[Balance]), 0)
// Format: Whole Number


// ================================================================================
// SECTION 6: CASH FLOW (8 measures)
// Calculate directly from Payment and related tables
// ================================================================================

// üí∞ Cash received from customers
CASH - Received = SUM(Payment[Amount])
// Format: Currency, 0 decimals

// üí∞ Cash paid to vendors
CASH - Paid Out = SUM(BillPayment[Amount]) + SUM(Purchase[Amount])
// Format: Currency, 0 decimals

// üí∞ Net cash flow (direct calculation)
CASH - Net Flow = SUM(Payment[Amount]) - (SUM(BillPayment[Amount]) + SUM(Purchase[Amount]))
// Format: Currency, 0 decimals

// üí∞ Operating cash flow YTD
CASH - Operating Flow YTD = 
TOTALYTD(SUM(Payment[Amount]), Calendar[Date]) - TOTALYTD(SUM(BillPayment[Amount]) + SUM(Purchase[Amount]), Calendar[Date])
// Format: Currency, 0 decimals

// üí∞ Total cash inflows
CASH - Total Inflows = SUM(Payment[Amount]) + SUM(SalesReceipt[Amount]) + SUM(Deposit[Amount])
// Format: Currency, 0 decimals

// üìä Cash conversion rate
CASH - Conversion Rate = DIVIDE(SUM(Payment[Amount]), SUM(Invoice[TotalAmount]), 0)
// Format: Percentage, 1 decimal

// üî¢ Cash runway in months
CASH - Runway Months = 
VAR Available = SUM(Invoice[Balance]) + SUM(Payment[Amount])
VAR MonthlyBurn = DIVIDE(SUM(Purchase[Amount]), 12, 0)
RETURN DIVIDE(Available, MonthlyBurn, 0)
// Format: Whole Number

// üìù Cash flow status
CASH - Flow Status = 
VAR NetFlow = SUM(Payment[Amount]) - (SUM(BillPayment[Amount]) + SUM(Purchase[Amount]))
RETURN IF(NetFlow > 0, "Positive", IF(NetFlow < 0, "Negative", "Neutral"))
// Format: Text


// ================================================================================
// SECTION 7: TAX PLANNING (20 measures) üî•
// Calculate from PurchaseLineItems for detail
// ================================================================================

// üí∞ Fixed asset purchases
TAX - Fixed Asset Purchases = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, Account[AccountType] = "Fixed Asset")
)
// Format: Currency, 0 decimals

// üí∞ Section 179 opportunity
TAX - Section 179 Opportunity = 
VAR Purchases = CALCULATE(SUM(PurchaseLineItems[Amount]), FILTER(Account, Account[AccountType] = "Fixed Asset"))
VAR Limit = 1220000
RETURN MIN(Purchases, Limit)
// Format: Currency, 0 decimals

// üí∞ Bonus depreciation available
TAX - Bonus Depreciation Avail = 
CALCULATE(SUM(PurchaseLineItems[Amount]), FILTER(Account, Account[AccountType] = "Fixed Asset")) * 0.60
// Format: Currency, 0 decimals

// üí∞ Meals & entertainment expenses
TAX - Meals & Entertainment = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(
        Account,
        CONTAINSSTRING(Account[AccountName], "Meals") ||
        CONTAINSSTRING(Account[AccountName], "Entertainment") ||
        CONTAINSSTRING(Account[AccountName], "Meal")
    )
)
// Format: Currency, 0 decimals

// üí∞ Deductible meals (50%)
TAX - Meals Deductible = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(
        Account,
        CONTAINSSTRING(Account[AccountName], "Meals") ||
        CONTAINSSTRING(Account[AccountName], "Entertainment")
    )
) * 0.50
// Format: Currency, 0 decimals

// üí∞ Non-deductible meals
TAX - Meals Non-Deductible = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, CONTAINSSTRING(Account[AccountName], "Meals") || CONTAINSSTRING(Account[AccountName], "Entertainment"))
) * 0.50
// Format: Currency, 0 decimals

// üí∞ Owner distributions
TAX - Owner Distributions = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(
        Account,
        CONTAINSSTRING(Account[AccountName], "Distribution") ||
        CONTAINSSTRING(Account[AccountName], "Draw") ||
        CONTAINSSTRING(Account[AccountName], "Owner")
    )
)
// Format: Currency, 0 decimals

// üí∞ Retirement contributions
TAX - Retirement Contributions = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(
        Account,
        CONTAINSSTRING(Account[AccountName], "401k") ||
        CONTAINSSTRING(Account[AccountName], "SEP") ||
        CONTAINSSTRING(Account[AccountName], "IRA") ||
        CONTAINSSTRING(Account[AccountName], "Retirement")
    )
)
// Format: Currency, 0 decimals

// üí∞ Retirement room remaining
TAX - Retirement Room = 
69000 - CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, CONTAINSSTRING(Account[AccountName], "401k") || CONTAINSSTRING(Account[AccountName], "SEP") || CONTAINSSTRING(Account[AccountName], "IRA"))
)
// Format: Currency, 0 decimals

// üìä Retirement utilization
TAX - Retirement Utilization % = 
DIVIDE(
    CALCULATE(SUM(PurchaseLineItems[Amount]), FILTER(Account, CONTAINSSTRING(Account[AccountName], "401k") || CONTAINSSTRING(Account[AccountName], "SEP"))),
    69000,
    0
)
// Format: Percentage, 1 decimal

// üí∞ Vehicle expenses
TAX - Vehicle Expenses = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(
        Account,
        CONTAINSSTRING(Account[AccountName], "Vehicle") ||
        CONTAINSSTRING(Account[AccountName], "Auto") ||
        CONTAINSSTRING(Account[AccountName], "Car")
    )
)
// Format: Currency, 0 decimals

// üí∞ Home office expenses
TAX - Home Office Expenses = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, CONTAINSSTRING(Account[AccountName], "Home Office") || CONTAINSSTRING(Account[AccountName], "Rent - Home"))
)
// Format: Currency, 0 decimals

// üí∞ Health insurance premiums
TAX - Health Insurance = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, CONTAINSSTRING(Account[AccountName], "Health Insurance") || CONTAINSSTRING(Account[AccountName], "Medical"))
)
// Format: Currency, 0 decimals

// üí∞ Business travel expenses
TAX - Business Travel = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, CONTAINSSTRING(Account[AccountName], "Travel"))
)
// Format: Currency, 0 decimals

// üí∞ Professional fees
TAX - Professional Fees = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, CONTAINSSTRING(Account[AccountName], "Legal") || CONTAINSSTRING(Account[AccountName], "Professional") || CONTAINSSTRING(Account[AccountName], "Accounting"))
)
// Format: Currency, 0 decimals

// üí∞ Charitable contributions
TAX - Charitable Contributions = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(Account, CONTAINSSTRING(Account[AccountName], "Charitable") || CONTAINSSTRING(Account[AccountName], "Donation"))
)
// Format: Currency, 0 decimals

// üí∞ Estimated taxable income
TAX - Estimated Taxable Income = 
VAR GrossProfit = SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])
VAR MealsDeduct = CALCULATE(SUM(PurchaseLineItems[Amount]), FILTER(Account, CONTAINSSTRING(Account[AccountName], "Meals"))) * 0.50
RETURN GrossProfit - MealsDeduct
// Format: Currency, 0 decimals

// üí∞ Estimated quarterly tax
TAX - Estimated Quarterly Tax = 
VAR TaxableIncome = (SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount]))
RETURN TaxableIncome * 0.25 / 4
// Format: Currency, 0 decimals

// üí∞ QBI deduction estimate
TAX - QBI Deduction Estimate = 
(SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])) * 0.20
// Format: Currency, 0 decimals

// üí∞ Self-employment tax estimate
TAX - Self Employment Tax Est = 
(SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])) * 0.153
// Format: Currency, 0 decimals


// ================================================================================
// SECTION 8: CUSTOMER METRICS (10 measures)
// Calculate from Customer and Invoice tables
// ================================================================================

// üî¢ Total customers
CUST - Total Customers = DISTINCTCOUNT(Customer[CustomerId])
// Format: Whole Number

// üî¢ Active customers
CUST - Active Customers = DISTINCTCOUNT(Invoice[CustomerId])
// Format: Whole Number

// üí∞ Average revenue per customer
CUST - Avg Revenue Per = DIVIDE(SUM(Invoice[TotalAmount]), DISTINCTCOUNT(Invoice[CustomerId]), 0)
// Format: Currency, 0 decimals

// üí∞ Customer lifetime value
CUST - Lifetime Value = DIVIDE(SUM(Invoice[TotalAmount]), DISTINCTCOUNT(Invoice[CustomerId]), 0)
// Format: Currency, 0 decimals

// üí∞ Top customer revenue
CUST - Top Customer Revenue = 
MAXX(TOPN(1, VALUES(Customer[CustomerName]), SUM(Invoice[TotalAmount]), DESC), SUM(Invoice[TotalAmount]))
// Format: Currency, 0 decimals

// üìä Revenue concentration
CUST - Top Customer % = 
VAR TopRev = MAXX(TOPN(1, VALUES(Customer[CustomerName]), SUM(Invoice[TotalAmount]), DESC), SUM(Invoice[TotalAmount]))
VAR TotalRev = SUM(Invoice[TotalAmount])
RETURN DIVIDE(TopRev, TotalRev, 0)
// Format: Percentage, 1 decimal

// üî¢ New customers this year
CUST - New This Year = 
CALCULATE(
    DISTINCTCOUNT(Invoice[CustomerId]),
    FILTER(
        Invoice,
        YEAR(Invoice[Date]) = YEAR(TODAY()) &&
        CALCULATE(MIN(Invoice[Date]), ALLEXCEPT(Invoice, Invoice[CustomerId])) >= DATE(YEAR(TODAY()), 1, 1)
    )
)
// Format: Whole Number

// üìä Customer retention rate
CUST - Retention Rate = 
VAR LastYear = CALCULATE(DISTINCTCOUNT(Invoice[CustomerId]), DATEADD(Calendar[Date], -1, YEAR))
VAR ThisYear = DISTINCTCOUNT(Invoice[CustomerId])
VAR NewCustomers = CALCULATE(DISTINCTCOUNT(Invoice[CustomerId]), FILTER(Invoice, YEAR(Invoice[Date]) = YEAR(TODAY()) && CALCULATE(MIN(Invoice[Date]), ALLEXCEPT(Invoice, Invoice[CustomerId])) >= DATE(YEAR(TODAY()), 1, 1)))
VAR Retained = ThisYear - NewCustomers
RETURN DIVIDE(Retained, LastYear, 0)
// Format: Percentage, 1 decimal

// üî¢ Invoice count
CUST - Invoice Count = COUNTROWS(Invoice)
// Format: Whole Number

// üî¢ Lost customers
CUST - Lost Customers = 
VAR LastYear = CALCULATE(DISTINCTCOUNT(Invoice[CustomerId]), DATEADD(Calendar[Date], -1, YEAR))
VAR ThisYear = DISTINCTCOUNT(Invoice[CustomerId])
VAR NewThis = CALCULATE(DISTINCTCOUNT(Invoice[CustomerId]), FILTER(Invoice, YEAR(Invoice[Date]) = YEAR(TODAY()) && CALCULATE(MIN(Invoice[Date]), ALLEXCEPT(Invoice, Invoice[CustomerId])) >= DATE(YEAR(TODAY()), 1, 1)))
VAR Retained = ThisYear - NewThis
RETURN LastYear - Retained
// Format: Whole Number


// ================================================================================
// SECTION 9: VENDOR METRICS (6 measures)
// Calculate from Vendor and Purchase tables
// ================================================================================

// üî¢ Total vendors
VENDOR - Total Vendors = DISTINCTCOUNT(Vendor[VendorId])
// Format: Whole Number

// üî¢ Active vendors
VENDOR - Active Vendors = DISTINCTCOUNT(Purchase[VendorId])
// Format: Whole Number

// üí∞ Average spend per vendor
VENDOR - Avg Spend Per = DIVIDE(SUM(Purchase[Amount]), DISTINCTCOUNT(Purchase[VendorId]), 0)
// Format: Currency, 0 decimals

// üí∞ Top vendor spend
VENDOR - Top Vendor Spend = 
MAXX(TOPN(1, VALUES(Vendor[VendorName]), SUM(Purchase[Amount]), DESC), SUM(Purchase[Amount]))
// Format: Currency, 0 decimals

// üìä Vendor concentration
VENDOR - Top Vendor % = 
VAR TopSpend = MAXX(TOPN(1, VALUES(Vendor[VendorName]), SUM(Purchase[Amount]), DESC), SUM(Purchase[Amount]))
VAR TotalSpend = SUM(Purchase[Amount])
RETURN DIVIDE(TopSpend, TotalSpend, 0)
// Format: Percentage, 1 decimal

// üí∞ 1099 vendor payments
VENDOR - 1099 Payments = 
CALCULATE(SUM(Purchase[Amount]), FILTER(Vendor, Vendor[Is1099] = TRUE))
// Format: Currency, 0 decimals


// ================================================================================
// SECTION 10: EFFICIENCY METRICS (8 measures)
// ================================================================================

// üí∞ Revenue per employee
EFFICIENCY - Revenue Per Employee = 
VAR EmployeeCount = DISTINCTCOUNT(Employee[EmployeeId])
RETURN IF(EmployeeCount > 0, DIVIDE(SUM(Invoice[TotalAmount]), EmployeeCount, 0), BLANK())
// Format: Currency, 0 decimals

// üí∞ Profit per employee
EFFICIENCY - Profit Per Employee = 
VAR EmployeeCount = DISTINCTCOUNT(Employee[EmployeeId])
VAR GrossProfit = SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount])
RETURN IF(EmployeeCount > 0, DIVIDE(GrossProfit, EmployeeCount, 0), BLANK())
// Format: Currency, 0 decimals

// üî¢ Transactions per day
EFFICIENCY - Transactions Per Day = 
DIVIDE(COUNTROWS(Invoice) + COUNTROWS(Purchase), COUNTROWS(Calendar), 0)
// Format: Whole Number

// üí∞ Average transaction size
EFFICIENCY - Avg Transaction Size = 
VAR TotalValue = SUM(Invoice[TotalAmount]) + SUM(Purchase[Amount])
VAR TotalCount = COUNTROWS(Invoice) + COUNTROWS(Purchase)
RETURN DIVIDE(TotalValue, TotalCount, 0)
// Format: Currency, 0 decimals

// üìä Liquidity ratio
EFFICIENCY - Liquidity Ratio = 
DIVIDE(SUM(Invoice[Balance]) + SUM(Payment[Amount]), SUM(Bill[Balance]), 0)
// Format: Decimal, 2 decimals

// üìä Asset turnover
EFFICIENCY - Asset Turnover = 
DIVIDE(SUM(Invoice[TotalAmount]), SUM(Invoice[Balance]), 0)
// Format: Decimal, 2 decimals

// üí∞ Average daily revenue
EFFICIENCY - Avg Daily Revenue = 
DIVIDE(SUM(Invoice[TotalAmount]), COUNTROWS(Calendar), 0)
// Format: Currency, 0 decimals

// üìä Financial health score
EFFICIENCY - Financial Health = 
VAR ProfitMargin = DIVIDE(SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount]), SUM(Invoice[TotalAmount]), 0)
VAR RevenueGrowth = DIVIDE(SUM(Invoice[TotalAmount]) - CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date])), CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date])), 0)
VAR ExpenseRatio = DIVIDE(SUM(Purchase[Amount]), SUM(Invoice[TotalAmount]), 0)
VAR CollectionRate = DIVIDE(SUM(Payment[Amount]), SUM(Invoice[TotalAmount]), 0)
RETURN (ProfitMargin * 0.3) + (RevenueGrowth * 0.3) + ((1 - ExpenseRatio) * 0.2) + (CollectionRate * 0.2)
// Format: Percentage, 1 decimal


// ================================================================================
// SECTION 11: KPI STATUS INDICATORS (8 measures)
// ================================================================================

// üìù Profit health status
KPI - Profit Health = 
VAR Margin = DIVIDE(SUM(Invoice[TotalAmount]) - SUM(Purchase[Amount]), SUM(Invoice[TotalAmount]), 0)
RETURN SWITCH(TRUE(), Margin >= 0.20, "Excellent", Margin >= 0.15, "Good", Margin >= 0.10, "Fair", Margin >= 0.05, "Warning", "Critical")
// Format: Text

// üìù Revenue trend
KPI - Revenue Trend = 
VAR Growth = DIVIDE(SUM(Invoice[TotalAmount]) - CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date])), CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date])), 0)
RETURN IF(Growth > 0, "‚Üë Growing", IF(Growth < 0, "‚Üì Declining", "‚Üí Flat"))
// Format: Text

// üìù Collection risk
KPI - Collection Risk = 
VAR DSO = DIVIDE(SUM(Invoice[Balance]), SUM(Invoice[TotalAmount]), 0) * 365
RETURN SWITCH(TRUE(), DSO <= 30, "Low Risk", DSO <= 45, "Moderate", DSO <= 60, "High Risk", "Critical")
// Format: Text

// üìù Expense control
KPI - Expense Control = 
VAR ExpGrowth = DIVIDE(SUM(Purchase[Amount]) - CALCULATE(SUM(Purchase[Amount]), SAMEPERIODLASTYEAR(Calendar[Date])), CALCULATE(SUM(Purchase[Amount]), SAMEPERIODLASTYEAR(Calendar[Date])), 0)
VAR RevGrowth = DIVIDE(SUM(Invoice[TotalAmount]) - CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date])), CALCULATE(SUM(Invoice[TotalAmount]), SAMEPERIODLASTYEAR(Calendar[Date])), 0)
RETURN IF(ExpGrowth < RevGrowth, "Controlled", IF(ExpGrowth > RevGrowth * 1.5, "Concern", "Monitor"))
// Format: Text

// üìù Liquidity status
KPI - Liquidity Status = 
VAR Ratio = DIVIDE(SUM(Invoice[Balance]) + SUM(Payment[Amount]), SUM(Bill[Balance]), 0)
RETURN SWITCH(TRUE(), Ratio >= 2, "Strong", Ratio >= 1.5, "Adequate", Ratio >= 1, "Weak", "Critical")
// Format: Text

// üìù Vendor payment status
KPI - Vendor Payment = 
VAR DPO = DIVIDE(SUM(Bill[Balance]), SUM(Purchase[Amount]), 0) * 365
RETURN SWITCH(TRUE(), DPO <= 30, "On Time", DPO <= 45, "Slightly Late", DPO <= 60, "Late", "Very Late")
// Format: Text

// üìù Tax planning status
KPI - Tax Planning Status = 
VAR RetireUtil = DIVIDE(CALCULATE(SUM(PurchaseLineItems[Amount]), FILTER(Account, CONTAINSSTRING(Account[AccountName], "Retirement"))), 69000, 0)
RETURN IF(RetireUtil >= 0.80, "Optimized", IF(RetireUtil >= 0.50, "Good", IF(RetireUtil > 0, "Underutilized", "Not Used")))
// Format: Text

// üìù Working capital status
KPI - Working Capital = 
VAR WC = SUM(Invoice[Balance]) - SUM(Bill[Balance])
RETURN IF(WC > 0, "Positive", IF(WC < 0, "Negative", "Neutral"))
// Format: Text


// ================================================================================
// SECTION 12: HOME CARE SPECIFIC METRICS (20 measures) üè•
// ================================================================================

// üî¢ Active clients (patients)
HC - Active Clients = DISTINCTCOUNT(Invoice[CustomerId])
// Format: Whole Number

// üí∞ Average revenue per client
HC - Avg Revenue Per Client = DIVIDE(SUM(Invoice[TotalAmount]), DISTINCTCOUNT(Invoice[CustomerId]), 0)
// Format: Currency, 0 decimals

// üí∞ Average revenue per visit
HC - Avg Revenue Per Visit = DIVIDE(SUM(Invoice[TotalAmount]), COUNTROWS(Invoice), 0)
// Format: Currency, 0 decimals

// üî¢ Total visits
HC - Total Visits = COUNTROWS(Invoice)
// Format: Whole Number

// üí∞ Medicare revenue
HC - Medicare Revenue = 
CALCULATE(
    SUM(InvoiceLineItems[Amount]),
    FILTER(Item, CONTAINSSTRING(Item[Name], "Medicare") || CONTAINSSTRING(Item[ItemName], "Medicare"))
)
// Format: Currency, 0 decimals

// üí∞ Medicaid revenue
HC - Medicaid Revenue = 
CALCULATE(
    SUM(InvoiceLineItems[Amount]),
    FILTER(Item, CONTAINSSTRING(Item[Name], "Medicaid") || CONTAINSSTRING(Item[ItemName], "Medicaid"))
)
// Format: Currency, 0 decimals

// üí∞ Private pay revenue
HC - Private Pay Revenue = 
CALCULATE(
    SUM(InvoiceLineItems[Amount]),
    FILTER(Item, CONTAINSSTRING(Item[Name], "Private") || CONTAINSSTRING(Item[ItemName], "Private"))
)
// Format: Currency, 0 decimals

// üí∞ Insurance revenue
HC - Insurance Revenue = 
VAR Total = SUM(Invoice[TotalAmount])
VAR Medicare = CALCULATE(SUM(InvoiceLineItems[Amount]), FILTER(Item, CONTAINSSTRING(Item[Name], "Medicare")))
VAR Medicaid = CALCULATE(SUM(InvoiceLineItems[Amount]), FILTER(Item, CONTAINSSTRING(Item[Name], "Medicaid")))
VAR Private = CALCULATE(SUM(InvoiceLineItems[Amount]), FILTER(Item, CONTAINSSTRING(Item[Name], "Private")))
RETURN Total - Medicare - Medicaid - Private
// Format: Currency, 0 decimals

// üìä Medicare revenue percentage
HC - Medicare % = 
DIVIDE(
    CALCULATE(SUM(InvoiceLineItems[Amount]), FILTER(Item, CONTAINSSTRING(Item[Name], "Medicare"))),
    SUM(Invoice[TotalAmount]),
    0
)
// Format: Percentage, 1 decimal

// üìä Medicaid revenue percentage
HC - Medicaid % = 
DIVIDE(
    CALCULATE(SUM(InvoiceLineItems[Amount]), FILTER(Item, CONTAINSSTRING(Item[Name], "Medicaid"))),
    SUM(Invoice[TotalAmount]),
    0
)
// Format: Percentage, 1 decimal

// üìä Private pay percentage
HC - Private Pay % = 
DIVIDE(
    CALCULATE(SUM(InvoiceLineItems[Amount]), FILTER(Item, CONTAINSSTRING(Item[Name], "Private"))),
    SUM(Invoice[TotalAmount]),
    0
)
// Format: Percentage, 1 decimal

// üí∞ Direct care labor costs
HC - Direct Care Labor = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(
        Account,
        CONTAINSSTRING(Account[AccountName], "Caregiver") ||
        CONTAINSSTRING(Account[AccountName], "Direct Care") ||
        CONTAINSSTRING(Account[AccountName], "CNA") ||
        CONTAINSSTRING(Account[AccountName], "HHA")
    )
)
// Format: Currency, 0 decimals

// üí∞ Administrative labor costs
HC - Admin Labor = 
CALCULATE(
    SUM(PurchaseLineItems[Amount]),
    FILTER(
        Account,
        CONTAINSSTRING(Account[AccountName], "Admin") ||
        CONTAINSSTRING(Account[AccountName], "Office Staff") ||
        CONTAINSSTRING(Account[AccountN
